#pragma once

#include <windows.h>
#include <stdio.h>

#include "pe_virtual_to_raw.h"

bool sections_raw_to_virtual(BYTE* payload, SIZE_T payload_size, BYTE* destAddress)
{
    if (payload == NULL) return false;

    IMAGE_NT_HEADERS* payload_nt_hdr = get_nt_hrds(payload);
    if (payload_nt_hdr == NULL) {
        printf("Invalid payload: %p\n", payload);
        return false;
    }
    //copy payload's headers:
    const DWORD kHdrsSize = payload_nt_hdr->OptionalHeader.SizeOfHeaders;
    memcpy(destAddress, payload, kHdrsSize);

    LPVOID secptr = &(payload_nt_hdr->OptionalHeader);
    const DWORD kOptHdrSize = payload_nt_hdr->FileHeader.SizeOfOptionalHeader;

    //copy all the sections, one by one:
    secptr = LPVOID((DWORD) secptr + kOptHdrSize);

    printf("Coping sections locally:\n");
    for (WORD i = 0; i < payload_nt_hdr->FileHeader.NumberOfSections; i++) {
       PIMAGE_SECTION_HEADER next_sec = (PIMAGE_SECTION_HEADER)((DWORD)secptr + (IMAGE_SIZEOF_SECTION_HEADER * i));

       LPVOID section_mapped = (BYTE*) payload + next_sec->VirtualAddress;
       LPVOID section_raw_ptr = destAddress + next_sec->PointerToRawData;

       memcpy(section_raw_ptr, section_mapped, next_sec->SizeOfRawData);
       printf("[+] %s to: %p\n", next_sec->Name, section_raw_ptr);
    }
    return true;
}
